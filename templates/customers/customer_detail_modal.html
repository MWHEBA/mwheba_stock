ص{% load custom_filters %}
{% load custom_math %}
<!-- قالب تفاصيل العميل المختصر للعرض في المودال -->
<div class="customer-details p-4">
    <!-- بطاقة معلومات العميل الأساسية -->
    <div class="text-center mb-4 pb-3 border-bottom">
        <div class="customer-avatar mb-3 mx-auto">
            <div class="avatar-title rounded-circle bg-{{ customer.get_status_display_class }} text-white" style="width: 64px; height: 64px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user fs-3"></i>
            </div>
        </div>
        <h4 class="fw-bold mb-1">{{ customer.name }}</h4>
        <p class="text-muted mb-0">{{ customer.code }}</p>
        
        <div class="mt-3">
            {% if customer.status == 'active' %}
                <span class="badge bg-success rounded-pill px-3 py-2"><i class="fas fa-check-circle me-1"></i> نشط</span>
            {% elif customer.status == 'inactive' %}
                <span class="badge bg-warning text-dark rounded-pill px-3 py-2"><i class="fas fa-exclamation-circle me-1"></i> غير نشط</span>
            {% else %}
                <span class="badge bg-danger rounded-pill px-3 py-2"><i class="fas fa-ban me-1"></i> محظور</span>
            {% endif %}
            
            {% if customer.is_vip %}
                <span class="badge bg-warning text-dark rounded-pill px-3 py-2 ms-2"><i class="fas fa-crown me-1"></i> VIP</span>
            {% endif %}
            
            {% if customer.category %}
                <span class="badge bg-{{ customer.category.color_code }} rounded-pill px-3 py-2 ms-2">
                    <i class="fas fa-tag me-1"></i> {{ customer.category.name }}
                </span>
            {% endif %}
        </div>
    </div>
    
    <div class="row g-3">
        <!-- معلومات أساسية وتواصل -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-circle text-primary me-2"></i> معلومات الاتصال
                    </h5>
                    <a href="{% url 'customer-detail' customer.id %}" class="btn btn-sm btn-outline-primary" title="عرض الصفحة الكاملة">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span><i class="fas fa-phone text-primary me-2"></i> رقم الهاتف:</span>
                            <span class="fw-medium" dir="ltr">{{ customer.phone|default:"--" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span><i class="fas fa-envelope text-primary me-2"></i> البريد الإلكتروني:</span>
                            <span class="fw-medium">{{ customer.email|default:"--" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span><i class="fas fa-map-marker-alt text-primary me-2"></i> العنوان:</span>
                            <span>{{ customer.address|default:"--" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span><i class="fas fa-calendar-alt text-primary me-2"></i> تاريخ التسجيل:</span>
                            <span>{{ customer.created_at|date:"Y-m-d" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span><i class="fas fa-shopping-cart text-primary me-2"></i> آخر معاملة:</span>
                            <span>{{ customer.last_purchase_date|date:"Y-m-d"|default:"--" }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- المعلومات المالية -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-money-bill-wave text-success me-2"></i> المعلومات المالية
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">المديونية الحالية:</span>
                            <span class="fs-5 fw-bold {% if customer.debt > 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ customer.debt|floatformat:2 }} ج.م
                            </span>
                        </div>
                        {% if customer.credit_limit > 0 %}
                            {% with debt_percentage=customer.debt|div:customer.credit_limit|mul:100|floatformat:0 %}
                                <div class="progress" style="height: 10px;" title="المديونية">
                                    <div class="progress-bar {% if customer.debt > customer.credit_limit %}bg-danger{% else %}bg-primary{% endif %}" 
                                        role="progressbar" 
                                        style="width: {% if customer.debt > customer.credit_limit %}100{% else %}{{ debt_percentage|default:0 }}{% endif %}%" 
                                        aria-valuenow="{{ debt_percentage }}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                    </div>
                                </div>
                            {% endwith %}
                        {% endif %}
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span><i class="fas fa-chart-line text-success me-2"></i> إجمالي المبيعات:</span>
                            <span class="fw-bold text-success">{{ customer.total_sales|floatformat:2 }} ج.م</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span><i class="fas fa-credit-card text-primary me-2"></i> حد الائتمان:</span>
                            <span>
                                {% if customer.credit_limit > 0 %} 
                                    {{ customer.credit_limit|floatformat:2 }} ج.م
                                {% else %}
                                    <span class="text-muted">غير محدد</span>
                                {% endif %}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span><i class="fas fa-trophy text-warning me-2"></i> نقاط الولاء:</span>
                            <span class="fw-bold">{{ customer.points }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- فواتير العميل -->
    <div class="card border-0 shadow-sm my-3">
        <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-file-invoice text-primary me-2"></i> آخر الفواتير
            </h5>
            <a href="{% url 'sale-list' %}?customer={{ customer.id }}" class="btn btn-sm btn-outline-primary">
                عرض الكل <i class="fas fa-arrow-left ms-1"></i>
            </a>
        </div>
        <div class="card-body p-0">
            {% if sales %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">رقم الفاتورة</th>
                            <th scope="col">التاريخ</th>
                            <th scope="col">المبلغ</th>
                            <th scope="col">الحالة</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in sales %}
                        <tr>
                            <td><strong class="text-primary">#{{ sale.id }}</strong></td>
                            <td>{{ sale.sale_date|date:"Y-m-d" }}</td>
                            <td>{{ sale.total_price|floatformat:2 }} ج.م</td>
                            <td>
                                {% if sale.status == 'paid' %}
                                    <span class="badge bg-success">مدفوعة</span>
                                {% elif sale.status == 'partially_paid' %}
                                    <span class="badge bg-warning text-dark">مدفوعة جزئياً</span>
                                {% else %}
                                    <span class="badge bg-danger">غير مدفوعة</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'sale-detail' sale.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-receipt text-muted fa-2x mb-2"></i>
                <p class="mb-0">لا توجد فواتير لهذا العميل</p>
            </div>
            {% endif %}
        </div>
        <div class="card-footer bg-white text-center py-3">
            <a href="{% url 'sale-create' %}?customer_id={{ customer.id }}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus-circle me-1"></i> إنشاء فاتورة جديدة
            </a>
            <a href="{% url 'customer-detail' customer.id %}" class="btn btn-sm btn-secondary ms-2">
                <i class="fas fa-info-circle me-1"></i> عرض التفاصيل الكاملة
            </a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // جعل صفوف الجدول قابلة للنقر للانتقال إلى صفحة الفاتورة
        const tableRows = document.querySelectorAll('.table-hover tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('click', function(e) {
                // تجاهل النقر إذا كان على الزر
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.tagName === 'I') {
                    return;
                }
                
                // استخراج الرابط من زر العرض في نفس الصف
                const viewButton = this.querySelector('a.btn-outline-primary');
                if (viewButton && viewButton.href) {
                    window.location.href = viewButton.href;
                }
            });
            
            // إضافة مؤشر يد عند المرور فوق الصف
            row.style.cursor = 'pointer';
        });
    });
</script>

<style>
    .table tr:hover {
        background-color: rgba(0, 123, 255, 0.03);
    }
</style>
